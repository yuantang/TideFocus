# 缓存问题修复说明

## 问题描述

用户偶尔会遇到 404 错误，浏览器尝试加载旧版本的资源文件（带有不同哈希值的 JS/CSS 文件）。

### 错误示例
```
Failed to load resource: the server responded with a status of 404 ()
/assets/index-BF8ILGmd.css:1
/assets/index-BMm8xEEY.js:1
/assets/vendor-BZ_w19Dh.js:1
```

## 根本原因

1. **Service Worker 缓存策略问题**
   - Service Worker 缓存了旧版本的 index.html
   - 旧的 index.html 引用了已经不存在的资源文件
   - 每次构建时，Vite 会为 JS/CSS 文件生成新的哈希值

2. **浏览器缓存**
   - 浏览器可能缓存了旧版本的 HTML 文件
   - 即使服务器更新了，浏览器仍然使用缓存

## 修复方案

### 1. 更新 Service Worker 版本号
```javascript
// public/sw.js
const CACHE_NAME = 'tidefocus-v1.0.1'; // 从 v1.0.0 更新到 v1.0.1
const RUNTIME_CACHE = 'tidefocus-runtime-v1.0.1';
```

### 2. 改进缓存策略
为 JS/CSS 文件使用**网络优先策略**，避免缓存旧版本：

```javascript
// JS/CSS 文件 - 网络优先策略（避免缓存旧版本）
if (url.pathname.includes('/assets/') && (url.pathname.endsWith('.js') || url.pathname.endsWith('.css'))) {
  event.respondWith(
    fetch(request)
      .then((response) => {
        // 不缓存 JS/CSS 文件，始终从网络获取最新版本
        return response;
      })
      .catch(() => {
        // 网络失败时尝试从缓存获取
        return caches.match(request);
      })
  );
  return;
}
```

### 3. 添加版本检测机制
创建 `utils/versionCheck.ts`，在应用启动时自动检测版本更新：

```typescript
// 检查版本更新
export const checkVersionUpdate = (): boolean => {
  const storedVersion = localStorage.getItem(VERSION_KEY);
  if (storedVersion !== APP_VERSION) {
    return true; // 版本已更新
  }
  return false;
};

// 处理版本更新
export const handleVersionUpdate = async (): Promise<boolean> => {
  const isUpdated = checkVersionUpdate();
  if (isUpdated) {
    await clearVersionCache(); // 清除所有缓存
    updateStoredVersion(); // 更新版本号
    return true;
  }
  return false;
};
```

### 4. 在 App.tsx 中集成版本检测
```typescript
// 版本检测和缓存管理
useEffect(() => {
  initVersionCheck().catch(err => {
    console.error('Version check failed:', err);
  });
}, []);
```

## 工作原理

1. **首次访问**
   - 应用保存当前版本号（1.0.1）到 localStorage
   - Service Worker 缓存静态资源

2. **版本更新后**
   - 用户访问应用
   - 版本检测发现版本号不匹配（1.0.0 → 1.0.1）
   - 自动清除所有缓存
   - 更新版本号
   - 刷新页面加载最新资源

3. **Service Worker 更新**
   - 新的 Service Worker 检测到版本号变化
   - 自动删除旧缓存（tidefocus-v1.0.0）
   - 创建新缓存（tidefocus-v1.0.1）

## 用户体验

### 自动更新流程
1. 用户访问应用
2. 后台检测到版本更新
3. 自动清除缓存
4. 页面自动刷新（1秒延迟）
5. 加载最新版本

### 手动清除缓存
如果仍然遇到问题，用户可以：
1. 打开浏览器开发者工具（F12）
2. 在 Console 中执行：
   ```javascript
   // 清除所有缓存并刷新
   caches.keys().then(names => {
     names.forEach(name => caches.delete(name));
   }).then(() => location.reload(true));
   ```

## 预防措施

### 开发阶段
- 每次重大更新时更新版本号
- 测试 Service Worker 的缓存行为
- 使用 `npm run build` 验证构建输出

### 部署阶段
- 确保服务器正确配置缓存头
- 为 HTML 文件设置短缓存时间或 no-cache
- 为 JS/CSS 文件设置长缓存时间（因为有哈希值）

### 推荐的 Nginx 配置
```nginx
location / {
  # HTML 文件不缓存
  location ~* \.html$ {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
  }
  
  # JS/CSS 文件长缓存（因为有哈希值）
  location ~* \.(js|css)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
  }
  
  # 其他静态资源
  location ~* \.(jpg|jpeg|png|gif|ico|svg|woff|woff2)$ {
    add_header Cache-Control "public, max-age=2592000";
  }
}
```

## 测试验证

### 本地测试
1. 构建应用：`npm run build`
2. 启动预览：`npm run preview`
3. 打开浏览器开发者工具
4. 检查 Network 标签，确认资源加载正常
5. 检查 Application → Cache Storage，查看缓存内容

### 生产测试
1. 部署新版本
2. 清除浏览器缓存
3. 访问应用
4. 检查控制台是否有 404 错误
5. 验证版本号是否正确更新

## 相关文件

- `public/sw.js` - Service Worker 配置
- `utils/versionCheck.ts` - 版本检测工具
- `utils/registerSW.ts` - Service Worker 注册工具
- `App.tsx` - 版本检测集成
- `package.json` - 应用版本号

## 版本历史

- **v1.0.0** - 初始版本
- **v1.0.1** - 修复缓存问题，添加版本检测机制

